<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>build:file | Element 源码学习</title>
    <meta name="description" content="2019 年给自己定个小目标：把 ElementUI 源码学习一遍！">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.dcae4551.css" as="style"><link rel="preload" href="/assets/js/app.f9186b43.js" as="script"><link rel="preload" href="/assets/js/6.c0837127.js" as="script"><link rel="prefetch" href="/assets/js/10.0831797f.js"><link rel="prefetch" href="/assets/js/2.3badc248.js"><link rel="prefetch" href="/assets/js/3.c5b97358.js"><link rel="prefetch" href="/assets/js/4.6a99bf8e.js"><link rel="prefetch" href="/assets/js/5.1104ea96.js"><link rel="prefetch" href="/assets/js/7.22796872.js"><link rel="prefetch" href="/assets/js/8.c44a9e4b.js"><link rel="prefetch" href="/assets/js/9.4607545f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dcae4551.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Element 源码学习</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/art/" class="nav-link router-link-active">开始阅读</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="https://github.com/gongph/element-code-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  仓库地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/art/" class="nav-link router-link-active">开始阅读</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="https://github.com/gongph/element-code-learning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  仓库地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>第一部分： 序章</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>第二部分： 开端</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/art/command-line.html" class="sidebar-link">构建命令行总览</a></li><li><a href="/art/build-file.html" class="active sidebar-link">build:file</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/art/build-file.html#iconinit-js" class="sidebar-link">iconInit.js</a></li><li class="sidebar-sub-header"><a href="/art/build-file.html#build-entry-js" class="sidebar-link">build-entry.js</a></li><li class="sidebar-sub-header"><a href="/art/build-file.html#i18n-js" class="sidebar-link">i18n.js</a></li><li class="sidebar-sub-header"><a href="/art/build-file.html#version-js" class="sidebar-link">version.js</a></li><li class="sidebar-sub-header"><a href="/art/build-file.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/art/build-theme.html" class="sidebar-link">build:theme</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="build-file"><a href="#build-file" aria-hidden="true" class="header-anchor">#</a> build:file</h1> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token punctuation">{</span>
    <span class="token string">&quot;build:file&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;node build/bin/iconInit.js &amp; node build/bin/build-entry.js &amp; node build/bin/i18n.js &amp; node build/bin/version.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>补充下：</p> <ul><li><code>&amp;</code> 符连接的是并行执行的任务，即同时的平行执行互不影响</li> <li><code>&amp;&amp;</code> 符连接的是继发执行的任务，即只有前一个任务成功，才执行下一个任务</li></ul> <p>可以看到，该命令有四个并行任务，分别是：</p> <ul><li><code>node build/bin/iconInit.js</code></li> <li><code>node build/bin/build-entry.js</code></li> <li><code>node build/bin/i18n.js</code></li> <li><code>node build/bin/version.js</code></li></ul> <p>让我们一个一个文件开始看，以下所有的文件都在 <code>build/bin/</code> 目录下。</p> <h2 id="iconinit-js"><a href="#iconinit-js" aria-hidden="true" class="header-anchor">#</a> iconInit.js</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">// CSS强大的预处理器</span>
<span class="token keyword">var</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取主题文件夹下的字体文件</span>
<span class="token keyword">var</span> fontFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../packages/theme-chalk/src/icon.scss'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 解析字体文件生成一个 css 虚拟语法树</span>
<span class="token comment">// 这样我们后续就可以操作各种 css 规则了</span>
<span class="token comment">// 这里是获取的所有 css 节点集合</span>
<span class="token keyword">var</span> nodes <span class="token operator">=</span> postcss<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fontFile<span class="token punctuation">)</span><span class="token punctuation">.</span>nodes<span class="token punctuation">;</span>
<span class="token comment">// 保存字体类名</span>
<span class="token comment">// 例如：['info','success','danger','warning']</span>
<span class="token keyword">var</span> classList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 遍历 css 节点</span>
nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取 css 类选择器，比如：`.el-icon-info:before`</span>
  <span class="token keyword">var</span> selector <span class="token operator">=</span> node<span class="token punctuation">.</span>selector <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex">/\.el-icon-([^:]+):before/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> arr <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>arr <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// arr[1]: 'info'</span>
    classList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 最后是吧 `classList` 写入到 `examples/icon.json` 文件中</span>
<span class="token comment">// fs.writeFile(file, data[,options],callback)</span>
<span class="token comment">// data 参数可以是：String|Buffer|TypedArray|DataView</span>
<span class="token comment">// 故，这里把数组转成了字符串形式进行存储</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../examples/icon.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>classList<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>这个文件的目的是把 <code>packages/theme-chalk/src/icon.scss</code> 文件中 icon 类名以数组的形式输出到 <code>examples/icon.json</code> 文件中。</p> <p>比如， <code>icon.scss</code> 文件中的内容如下：</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.el-icon-info:before</span> <span class="token punctuation">{</span> <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">&quot;\e61a&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">.el-icon-error:before</span> <span class="token punctuation">{</span> <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">&quot;\e62c&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">.el-icon-success:before</span> <span class="token punctuation">{</span> <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">&quot;\e62d&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>经过命令 <code>node build/bin/iconInit.js</code> 执行后， <code>icon.json</code> 文件内容变为：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>'info'<span class="token punctuation">,</span> 'error'<span class="token punctuation">,</span> 'success'<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看下生成后的 <a href="https://github.com/ElemeFE/element/blob/dev/examples/icon.json" target="_blank" rel="noopener noreferrer">icon.json<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。 其中用到的插件：</p> <ul><li><a href="https://www.npmjs.com/package/postcss" target="_blank" rel="noopener noreferrer">postcss<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> Scss 预处理器</li></ul> <h2 id="build-entry-js"><a href="#build-entry-js" aria-hidden="true" class="header-anchor">#</a> build-entry.js</h2> <p>其实 <code>src/index.js</code> 文件就是它生成的。一开始我在想，<code>src/index.js</code> 文件中的内容这么多一个个的写不麻烦吗？ 现在才知道是通过这条命令自动生成的。</p> <p>内容有点多，我们看下重点：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 首先引入定义好的组件名及路径文件</span>
<span class="token keyword">var</span> Components <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../components.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// JSON 模板</span>
<span class="token keyword">var</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'json-templater/string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 文件名转大驼峰，</span>
<span class="token comment">// 例如：component-name -&gt; ComponentName</span>
<span class="token keyword">var</span> uppercamelcase <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uppercamelcase'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Node 系统模块</span>
<span class="token comment">// 操作系统相关的行末标志:</span>
<span class="token comment">// `\n` 在 POSIX 系统上</span>
<span class="token comment">// `\r\n` 在 Windows系统上</span>
<span class="token keyword">var</span> endOfLine <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">EOL</span><span class="token punctuation">;</span>
<span class="token comment">// 定义输出路径</span>
<span class="token keyword">var</span> <span class="token constant">OUTPUT_PATH</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../src/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义组件导入模板字符串</span>
<span class="token keyword">var</span> <span class="token constant">IMPORT_TEMPLATE</span> <span class="token operator">=</span> <span class="token string">'import {{name}} from \'../packages/{{package}}/index.js\';'</span><span class="token punctuation">;</span>
<span class="token comment">// 定义安装组件模板字符串</span>
<span class="token keyword">var</span> <span class="token constant">INSTALL_COMPONENT_TEMPLATE</span> <span class="token operator">=</span> <span class="token string">'  {{name}}'</span><span class="token punctuation">;</span>
<span class="token comment">// 定义内容模板字符串</span>
<span class="token comment">// 其中的 {{include}}、{{install}}、{{version}}、{{list}}</span>
<span class="token comment">// 都是通过 render 方法动态填充的</span>
<span class="token keyword">var</span> <span class="token constant">MAIN_TEMPLATE</span> <span class="token operator">=</span> <span class="token template-string"><span class="token string">`/* Automatically generated by './build/bin/build-entry.js' */
{{include}}
import locale from 'element-ui/src/locale';
import CollapseTransition from 'element-ui/src/transitions/collapse-transition';
const components = [
{{install}},
  CollapseTransition
];

...

module.exports = {
  version: '{{version}}',
  locale: locale.use,
  i18n: locale.i18n,
  install,
  CollapseTransition,
  Loading,
  {{list}}
};
module.exports.default = module.exports;
`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 删除 font 属性</span>
<span class="token comment">// 其实里面并没有 font 这个 key，不知道为啥要执行这一步？</span>
<span class="token keyword">delete</span> Components<span class="token punctuation">.</span>font<span class="token punctuation">;</span>

<span class="token comment">// 获取所有的 key</span>
<span class="token keyword">var</span> ComponentNames <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Components<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义三个用来插入插槽的数组</span>
<span class="token keyword">var</span> includeComponentTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> installTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> listTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 遍历</span>
ComponentNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>name <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 把所有的 key 转成大驼峰形式</span>
  <span class="token keyword">var</span> componentName <span class="token operator">=</span> <span class="token function">uppercamelcase</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 往数组里塞值</span>
  includeComponentTemplate<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token constant">IMPORT_TEMPLATE</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> componentName<span class="token punctuation">,</span>
    <span class="token keyword">package</span><span class="token punctuation">:</span> name
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 排除下面是四个组件</span>
  <span class="token comment">// 因为上面 MAIN_TEMPLATE 中已经安装到 Vue.prototype 上了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Loading'</span><span class="token punctuation">,</span> <span class="token string">'MessageBox'</span><span class="token punctuation">,</span> <span class="token string">'Notification'</span><span class="token punctuation">,</span> <span class="token string">'Message'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    installTemplate<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token constant">INSTALL_COMPONENT_TEMPLATE</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> componentName<span class="token punctuation">,</span>
      component<span class="token punctuation">:</span> name
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 排除 Loading 组件</span>
  <span class="token comment">// 因为上面 MAIN_TEMPLATE 中已经写死进去了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentName <span class="token operator">!==</span> <span class="token string">'Loading'</span><span class="token punctuation">)</span> listTemplate<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 替换插值模板，返回替换后的完成内容</span>
<span class="token comment">// 即你现在在 src/index.js 中看到的样子</span>
<span class="token keyword">var</span> template <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token constant">MAIN_TEMPLATE</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  include<span class="token punctuation">:</span> includeComponentTemplate<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>endOfLine<span class="token punctuation">)</span><span class="token punctuation">,</span>
  install<span class="token punctuation">:</span> installTemplate<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span> <span class="token operator">+</span> endOfLine<span class="token punctuation">)</span><span class="token punctuation">,</span>
  version<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VERSION</span> <span class="token operator">||</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
  list<span class="token punctuation">:</span> listTemplate<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span> <span class="token operator">+</span> endOfLine<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 最后写入到 src/index.js 中</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token constant">OUTPUT_PATH</span><span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 已经 build 完啦</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[build entry] DONE:'</span><span class="token punctuation">,</span> <span class="token constant">OUTPUT_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br></div></div><h2 id="i18n-js"><a href="#i18n-js" aria-hidden="true" class="header-anchor">#</a> i18n.js</h2> <p>这个文件的代码也不长：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Element官网国际化配置文件</span>
<span class="token keyword">var</span> langConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../examples/i18n/page.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 遍历</span>
langConfig<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>lang <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里先获取文件夹，目的是检查该文件夹是否存在</span>
    <span class="token comment">// 如果不存在则报错直接 catch 到创建新的</span>
    fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`../../examples/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> lang<span class="token punctuation">.</span>lang <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有这个文件夹则创建</span>
    <span class="token comment">// mkdirSync 方法是 mkdir 的同步版，即：</span>
    <span class="token comment">// 同步的创建一个文件夹，如果存在，则抛出异常</span>
    <span class="token comment">// 所以，上面先判断下这个文件是否存在</span>
    fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`../../examples/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> lang<span class="token punctuation">.</span>lang <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 遍历 pages 属性下的数据</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>lang<span class="token punctuation">.</span>pages<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>page <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// page值和 `examples/pages/template/` 下的模板名都是一一对应的</span>
    <span class="token comment">// 找到模板路径</span>
    <span class="token keyword">var</span> templatePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`../../examples/pages/template/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> page <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.tpl`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 输出路径，这里生成的是 .vue 文件</span>
    <span class="token keyword">var</span> outputPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`../../examples/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> lang<span class="token punctuation">.</span>lang <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> page <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.vue`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 同步读取模板文件内容</span>
    <span class="token keyword">var</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取对应的 page 对象</span>
    <span class="token comment">// page 对象下都是以数字为 key</span>
    <span class="token comment">// 这样做是为了好替换模板中的数字</span>
    <span class="token keyword">var</span> pairs <span class="token operator">=</span> lang<span class="token punctuation">.</span>pages<span class="token punctuation">[</span>page<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 遍历</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pairs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// key: 1,2,3,4,5...</span>
      <span class="token comment">// 替换模板中的 `&lt;%= ${ key } &gt;` 占位符</span>
      content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`&lt;%=\\s*</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> key <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\s*&gt;`</span></span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pairs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 写入到输出路径</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>这个文件的目的是根据国际化配置文件（<code>examples/i18n/page.json</code>）动态填充网站模板内容，并输出到对应的国际化目录下。</p> <h2 id="version-js"><a href="#version-js" aria-hidden="true" class="header-anchor">#</a> version.js</h2> <p>顾名思义，定是管理网站版本号的。我们来看下代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取当前项目的最新版本</span>
<span class="token keyword">var</span> version <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VERSION</span> <span class="token operator">||</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">;</span>
<span class="token comment">// 这些是旧版本了</span>
<span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'1.4.13'</span><span class="token punctuation">:</span> <span class="token string">'1.4'</span><span class="token punctuation">,</span> <span class="token string">'2.0.11'</span><span class="token punctuation">:</span> <span class="token string">'2.0'</span><span class="token punctuation">,</span> <span class="token string">'2.1.0'</span><span class="token punctuation">:</span> <span class="token string">'2.1'</span><span class="token punctuation">,</span> <span class="token string">'2.2.2'</span><span class="token punctuation">:</span> <span class="token string">'2.2'</span><span class="token punctuation">,</span> <span class="token string">'2.3.9'</span><span class="token punctuation">:</span> <span class="token string">'2.3'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 往数组里增加一个新本版</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">[</span>version<span class="token punctuation">]</span><span class="token punctuation">)</span> content<span class="token punctuation">[</span>version<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'2.4'</span><span class="token punctuation">;</span>
<span class="token comment">// 同样的道理，把版本数组转成字符串保存到 `examples/version.json` 中</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../examples/versions.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>至此，<code>build:file</code> 命名中的相关文件已经分析完啦。总结一下：</p> <ul><li><code>build/bin/iconInit.js</code> 负责生成网站字体图标列表，可以看<a href="http://element-cn.eleme.io/2.4/#/zh-CN/component/icon" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>build/bin/build-entry.js</code> 负责生成 <code>src/index.js</code> 文件，为接下来的其他命令服务</li> <li><code>build/bin/i18n.js</code> 负责网站国际化目录及页面的生成</li> <li><code>build/bin/version.js</code> 负责网站版本号的生成</li></ul></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/art/command-line.html" class="prev">
          构建命令行总览
        </a></span> <span class="next"><a href="/art/build-theme.html">
          build:theme
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.f9186b43.js" defer></script><script src="/assets/js/6.c0837127.js" defer></script>
  </body>
</html>
